<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>A2A CHAT</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>

<body>
<h2>A2A Chat</h2>
<form action="javascript:me.set('nickname',document.getElementById('meName').value)">
<h3>You are:&nbsp;&nbsp;&nbsp;<input type="text" id="meName" value="guest">
<input type="submit" value="Set nickname!">
</h3></form>
<h3><form action="javascript:me.postMessage()">
You say:&nbsp;&nbsp;&nbsp;<input type="text" id="messageBody" value="Hello world!">
<input type="submit" value="Shout!">
</h3></form>
<h3>You ear:&nbsp;&nbsp;&nbsp;<button onclick="document.getElementById('trace').innerHTML='';">clear</button></h3>
<pre id='trace' style="border:2px solid black;background:#EFE;"></pre>

<script type="text/javascript" src='myPrototype.js'></script>
<script type="text/javascript" src='hbc.js'></script>
<script type="text/javascript" src='jsonize.js'></script>
<script type="text/javascript" src='pubsubAgent.js'></script>
<script type="text/javascript" src='indexAgent.js'></script>
<script type="text/javascript" src='busAgent.js'></script>
<script type="text/javascript" src='autobus.js'></script>

<script type="text/javascript">

var cookies = {
   get:  function(name) {
      var start = document.cookie.indexOf(name + "=");
      if (start == -1) return null;
      var len = start + name.length + 1;
      var end = document.cookie.indexOf(";", len);
      if (end == -1) end = document.cookie.length;
      return unescape(document.cookie.substring(len, end));
   },
   set: function(name, value, expires, path, domain, secure) {
      document.cookie = name + "=" + escape(value) +
          ( expires ? ";expires=" + expires.toGMTString() : "") +
          ( path ? ";path=" + path : "") + 
          ( domain ? ";domain=" + domain : "") +
          ( secure ? ";secure" : "");
   }
};

function puts(msg) {
  var t = document.getElementById("trace");
  t.innerHTML = t.innerHTML.replace(/^/, msg + "\n");
}

var autobus = new Autobus();
autobus.init();

if(1)
autobus.hbc.logCB = function(msg) {
  puts("logCB: " + msg) ;
}

function log(msg) {
   return;
   puts(msg);
}

var pingsLog = {};
function onIntendeePing(intendee, variable, value) {
    pingsLog[intendee.name] = intendee;
    log("intendee " + intendee.name + " heard at " + new Date());
    if (me.ping < value) me.ping = value;
}

var url_map = eval("(" + (cookies.get("a2ac_icons") || "null") + ")")
                  || { "red": "./img/red.gif", "blue": "./img/blue.gif", "green": "./img/green.gif" };
function onIntendeeNickname(intendee, variable, value) {
    puts("intendee " + intendee.name + " nickname is " + value);
    if (intendee === me) {
      cookies.set("a2ac_nick", value);
      var url = url_map[value] || "./img/guest.gif";
      me.set("icon", url);
    }
}

function onIntendeeIcon(intendee, variable, value) {
    puts("intendee " + intendee.name + " icon url is " + value);
    if (intendee === me) {
       url_map[intendee.nickname] = value
       var expire = new Date();
       expire.setTime(Date.now() + 3600 * 24 * 100)
       cookies.set("a2ac_icons", jsonize(url_map), expire);
    }
}

function onNewIntendee(tagsnomy, tag, intendee) {
   puts("new intendee id " + intendee.name);
   intendee.subscribe("ping", onIntendeePing);
   intendee.subscribe("nickname", onIntendeeNickname);
   intendee.subscribe("icon", onIntendeeIcon);
}


function onMessageContent(message, variable, value) {
    var intendee = autobus.tagsonomy.getIndex(message.intendee)[0];
    var who = (intendee && intendee.nickname ? intendee.nickname : "intendee " + message.intendee);

    puts(who + " said: " + value);
}

function onMessageTimestamp(message, variable, value) {
    if (me.ping < value) me.ping = value;
}

var messagesQueue = [];

function onNewMessage(tagsonomy, tag, message) {
   log("new message " + message.name);
   message.subscribe("content", onMessageContent);
   message.subscribe("timestamp", onMessageTimestamp);
   messagesQueue.unshift(message);
   var removed = messagesQueue.splice(10,10);
   for (var lst = removed, l = lst.length, i = l - 1; i >= 0; i--) {
      log("message " + lst[i].name + " forgotten");
      lst[i].forget();
   }
}

autobus.tagsonomy.setSubscribe("intendee", onNewIntendee);
autobus.tagsonomy.setSubscribe("message", onNewMessage);

var me = new BusAgent(autobus, busAgentUUID("i"), BusAgent.prototype.here);
me.setTags("intendee");

me.postMessage = function() {
  var v = document.getElementById('messageBody');
  var msg = new BusAgent(autobus, busAgentUUID("m"), BusAgent.prototype.here);
  msg.sets({
    tags: ["message"],
    intendee: me.name,
    //to: otherIntendee,
    content: v.value,
    timestamp: 1 + me.ping
  });
  v.value = "";
}

me.ping = 0;
me.doPing = function() {
   this.set("ping", 1 + me.ping);
}


var lastPingsLog = {};
function cleanGone() {
  for (var lst = autobus.tagsonomy.getIndex("intendee"), l = lst.length, i = l - 1; i >= 0; i--) {
     var intendee=lst[i];
     if (intendee === me || pingsLog[intendee.name] || lastPingsLog[intendee.name])
        continue; // intendee still here

     // intendee is gone
     puts("intendee " + intendee.name + " is gone!");
     intendee.forget();
   }

   lastPingsLog = pingsLog;
   pingsLog = {};
}

me.doPing();
setInterval(function() { me.doPing() }, 60 * 2 * 1000 - 30 * Math.random() * 1000);
setInterval(cleanGone, 60 * 2 * 1000);


function autoConfig() {
  var nick = cookies.get("a2ac_nick");
  if (!nick) {
    var names = [];
    var intendees = autobus.tagsonomy.getIndex("intendee");
    for (var l = intendees.length, i = l - 1; i >= 0; i--)
      names.push(intendees[i].nickname);
    
    var lst = [ "red", "blue", "green", "purple", "orange", "pink", "gray" ];
    for (var l = lst.length, i = l - 1; i >= 0; i--) {
       if (names.indexOf(lst[i]) != -1) continue;
       nick = lst[i];
    }   
    if (!nick) {
      var default_prefix = "guest";
      var i = 2;
      while (names.indexOf(default_prefix + i) != -1) i++;
      nick = default_prefix + i;
    }
  }
  me.set("nickname", nick);
}

setTimeout(autoConfig, 3 * 1000);


</script>


</body>
</html>
