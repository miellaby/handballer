<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>A2A CHAT</title>
<meta http-equiv="Content-Type" content="text/html; charset=8859-1">
</head>

<body>
<h2>A2A Chat</h2>
<form action="javascript:me.set('nickname',document.getElementById('meName').value)">
<h3>You are:&nbsp;&nbsp;&nbsp;<input type="text" id="meName" value="guest">
<input type="submit" value="Set nickname!">
</h3></form>
<h3><form action="javascript:me.postMessage()">
You say:&nbsp;&nbsp;&nbsp;<input type="text" id="messageBody" value="Hello world!">
<input type="submit" value="Shout!">
</h3></form>
<h3>You ear:&nbsp;&nbsp;&nbsp;<button onclick="document.getElementById('trace').innerHTML='';">clear</button></h3>
<pre id='trace' style="border:2px solid black;background:#EFE;"></pre>

<script type="text/javascript" src='hbc.js'></script>
<script type="text/javascript" src='jsonize.js'></script>
<script type="text/javascript" src='pubsubAgent.js'></script>
<script type="text/javascript" src='indexAgent.js'></script>
<script type="text/javascript" src='busAgent.js'></script>
<script type="text/javascript" src='autobus.js'></script>

<script type="text/javascript">
function puts(msg) {
  var t = document.getElementById("trace");
  t.innerHTML = t.innerHTML.replace(/^/, msg + "\n") ;
}

var autobus = new Autobus();
autobus.init();

if(0)
autobus.hbc.logCB = function(msg) {
  puts("logCB: " + msg) ;
}

var pingsLog = {};

function log(msg) {
   return;
   puts(msg);
}

function onIntendeePing(intendee, variable, value) {
    pingsLog[intendee.name] = intendee;
    log("intendee " + intendee.name + " heard at " + new Date());
}

function onIntendeeNickname(intendee, variable, value) {
    puts("intendee " + intendee.name + " is also known as " + value);
}

function onMessageContent(message, variable, value) {
    var intendee = autobus.tagsonomy.getIndex(message.intendee)[0];
    var who = (intendee && intendee.nickname ? intendee.nickname : "intendee " + message.intendee);

    puts(who + " said: " + value);
}

function onNewIntendee(tagsnomy, tag, intendee) {
   puts("new intendee " + intendee.name);
   intendee.subscribe("ping", onIntendeePing);
   intendee.subscribe("nickname", onIntendeeNickname);
}

var messagesQueue = [];
function onNewMessage(tagsonomy, tag, message) {
   log("new message " + message.name);
   message.subscribe("content", onMessageContent);
   messagesQueue.unshift(message);
   var removed = messagesQueue.splice(10,10);
   for (var lst = removed, l = lst.length, i = l - 1; i >= 0; i--) {
      log("message " + lst[i].name + " forgotten");
      lst[i].forget();
   }
}

autobus.tagsonomy.setSubscribe("intendee", onNewIntendee);
autobus.tagsonomy.setSubscribe("message", onNewMessage);

var me = new BusAgent(autobus, busAgentUUID("i"), BusAgent.prototype.here);
me.setTags("intendee");

me.postMessage = function() {
  var v = document.getElementById('messageBody');
  var msg = new BusAgent(autobus, busAgentUUID("m"), BusAgent.prototype.here);
  msg.setTags("message");
  msg.set("intendee", me.name);
  //msg.set("to", otherIntendee);
  msg.set("content", v.value);
  v.value = "";
}

me.pingCounter = 1;
me.doPing = function() {
   this.set("ping", me.pingCounter++);
}


var lastPingsLog = null;
function cleanGone() {
   if (!lastPingsLog) { // 1st call
      lastPingsLog = pingsLog;
      return;
   }
     
   for (i in lastPingsLog) {
     if (pingsLog[i]) continue; // intendee still here
     // intendee gone
     puts("intendee " + i + " is gone!");
     lastPingsLog[i].forget();
   }
   lastPingsLog = pingsLog; 
   pingsLog = {};
}

me.doPing();
setInterval(function() { me.doPing() }, 60 * 2 * 100 - 30 * Math.random() * 100);
setInterval(cleanGone, 60 * 2 * 100);


</script>


</body>
</html>
